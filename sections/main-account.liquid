{{ 'customer.css' | asset_url | stylesheet_tag }}

{%- if section.settings.fullwidth -%}
	{%- assign container = 'container-full' -%}
{%- elsif section.settings.max_width != blank -%}
	{%- assign container = 'kretoss-container' -%}
{%- else -%}
	{%- assign container = 'page-width' -%}
{%- endif -%}

{%- assign max_width = '' -%}
{%- if section.settings.fullwidth == blank and section.settings.max_width != blank -%}
	{%- assign width_container = section.settings.max_width | plus: 0 -%}
	{%- capture max_width -%}style="max-width: {{ section.settings.max_width }};"{%- endcapture -%}
{%- endif -%}


{% assign margin 	= section.settings.margin | split: "|" %}
{% assign padding 	= section.settings.padding | split: "|" %}
{%- style -%}
  {%- if margin[0] != blank or padding[0] != blank -%}
    #shopify-section-{{ section.id }} .section-customer_account{
      {%- if margin[0] != blank -%}margin: {{ margin[0] }};{%- endif -%}
      {%- if padding[0] != blank -%}padding:{{ padding[0] }};{%- endif -%}
    }
	{%- endif -%}
	{%- if margin[1] != blank or padding[1] != blank -%}
		@media (max-width:1200px){
			#shopify-section-{{ section.id }} .section-customer_account{
				{%- if margin[1] != blank -%}margin: {{ margin[1] }};{%- endif -%}
				{%- if padding[1] != blank -%}padding:{{ padding[1] }};{%- endif -%}
			}
		}
	{%- endif -%}
	{%- if margin[2] != blank or padding[2] != blank -%}
		@media (max-width:991px){
			#shopify-section-{{ section.id }} .section-customer_account{
				{%- if margin[2] != blank -%}margin: {{ margin[2] }};{%- endif -%}
				{%- if padding[2] != blank -%}padding:{{ padding[2] }};{%- endif -%}
			}
		}
	{%- endif -%}
	{%- if margin[3] != blank or padding[3] != blank -%}
		@media (max-width:767px){
			#shopify-section-{{ section.id }} .section-customer_account{
				{%- if margin[3] != blank -%}margin: {{ margin[3] }};{%- endif -%}
				{%- if padding[3] != blank -%}padding:{{ padding[3] }};{%- endif -%}
			}
		}
	{%- endif -%}
{%- endstyle -%}

<div class="kretoss-section section-customer_account">
  <div class="{{ container }}" {{ max_width }}>
    <div class="customer account">
      <div class="main_account_head">
        <h2>My Account</h2>
      </div>
      <div class="edit_account_block">
        <form id="profile-form" class="profile_edit_form">
          <input type="hidden" name="customer_id" value="{{ customer.id }}">
          <div class="all_forms_field_blocks">
            <div class="form_field_box">
              <div class="field_head">
                <h4>Profile image</h4>
                <p>This image appears in your profile, comments, and shared caps.</p>
              </div>
              <div class="fields">
                <div class="edit_account_field">
                  <div class="profile_pic_field">
                    <div class="profile-image-uploader">
                      {% assign profile_img = customer.metafields.custom.profile_image %}
                      <div class="avatar-preview" id="avatarPreview">
                        {% if profile_img != blank %}
                          <img src="{{ profile_img }}" id="avatarImg">
                        {% else %}
                          <span class="avatar-letter">{{ customer.first_name | slice: 0, 1 }}</span>
                        {% endif %}
                      </div>
                      <div class="avatar-actions_info">
                        <div class="avatar-actions">
                          <label class="upload-btn">
                            Upload Image
                            <input type="file" id="avatarInput" accept="image/*" hidden>
                          </label>
                          <button type="button" id="removeAvatar" class="remove-btn">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M6 2H10M2 4H14M12.6667 4L12.1991 11.0129C12.129 12.065 12.0939 12.5911 11.8667 12.99C11.6666 13.3412 11.3648 13.6235 11.0011 13.7998C10.588 14 10.0607 14 9.0062 14H6.9938C5.93927 14 5.41202 14 4.99889 13.7998C4.63517 13.6235 4.33339 13.3412 4.13332 12.99C3.90607 12.5911 3.871 12.065 3.80086 11.0129L3.33333 4M6.66667 7V10.3333M9.33333 7V10.3333" stroke="#C6C6C6" stroke-width="1.33333" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                          </button>
                        </div>
                        <small>Recommended size: 120x120</small>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
            <div class="form_field_box">
               <div class="field_head">
                <h4>Your name</h4>
                <p>Changing your name below will update how your name appears when sharing a Cap, and in your profile.</p>
              </div>
              <div class="fields">
                <div class="edit_account_field">
                   <input name="first_name" value="{{ customer.first_name }}" class="edit_account_input" placeholder="First Name">
                   <div class="field-error"></div>
                </div>
                <div class="edit_account_field">
                  <input name="last_name" value="{{ customer.last_name }}" class="edit_account_input" placeholder="Last Name">
                  <div class="field-error"></div>
                </div>
              </div>
            </div>
            <div class="form_field_box">
               <div class="field_head">
                <h4>Contact email address</h4>
                <p>This is the email address you used to sign up to Cap with.!</p>
              </div>
              <div class="fields">
                <div class="edit_account_field">
                  <input name="email" value="{{ customer.email }}" class="edit_account_input" placeholder="Email Address">
                  <div class="field-error"></div>
                </div>
              </div>
            </div>
            <div class="form_field_box">
               <div class="field_head">
                <h4>Contact number</h4>
                <p>This is the email address you used to sign up to Cap with.!</p>
              </div>
              <div class="fields">
                <div class="edit_account_field">
                  <input name="phone" value="{{ customer.phone }}" class="edit_account_input" placeholder="phone">
                  <div class="field-error"></div>
                </div>
              </div>
            </div>
            <div class="form_field_box">
               <div class="field_head">
                <h4>Extra Fields</h4>
                <p>Changing your name below will update how your name appears when sharing a Cap, and in your profile.</p>
              </div>
              <div class="fields">
                <div class="edit_account_field">
                   <input name="gender" value="{{ customer.metafields.custom.gender }}" class="edit_account_input" placeholder="Gender">
                   <div class="field-error"></div>
                </div>
                <div class="edit_account_field">
                  <input name="age" value="{{ customer.metafields.custom.age }}" class="edit_account_input" placeholder="Age">
                  <div class="field-error"></div>
                </div>
              </div>
            </div>
            <div class="form_field_box">
               <div class="field_head">
                <h4>Social Profiles</h4>
                <p>Changing your name below will update how your name appears when sharing a Cap, and in your profile.</p>
              </div>
              <div class="fields">
                <div class="edit_account_field">
                   <input name="instagram" value="{{ customer.metafields.custom.instagram }}" class="edit_account_input" placeholder="Instagram">
                   <div class="field-error"></div>
                </div>
                <div class="edit_account_field">
                  <input name="twitter" value="{{ customer.metafields.custom.twitter }}" class="edit_account_input" placeholder="Twitter">
                  <div class="field-error"></div>
                </div>
              </div>
            </div>
            <div class="form_field_box">
               <div class="field_head">
                <h4>Address</h4>
                <p>Changing your name below will update how your name appears when sharing a Cap, and in your profile.</p>
              </div>
              <div class="fields">
                <div class="edit_account_field">
                   <input name="address1" value="{{ customer.default_address.address1 }}" class="edit_account_input" placeholder="Address Line 1">
                   <div class="field-error"></div>
                </div>
                <div class="edit_account_field">
                  <input name="address2" value="{{ customer.default_address.address2 }}" class="edit_account_input" placeholder="Address Line 2">
                </div>
                <div class="edit_account_col">
                  <div class="edit_account_field">
                    <input name="city" value="{{ customer.default_address.city }}" class="edit_account_input" placeholder="City / District">
                    <div class="field-error"></div>
                  </div>
                  <div class="edit_account_field">
                    <input name="province" value="{{ customer.default_address.province }}" class="edit_account_input" placeholder="State / Province">
                    <div class="field-error"></div>
                  </div>
                </div>
                <div class="edit_account_col">
                  <div class="edit_account_field">
                    <input name="zip" value="{{ customer.default_address.zip }}" class="edit_account_input" placeholder="Postal Code">
                    <div class="field-error"></div>
                  </div>
                  <div class="edit_account_field">
                    <input name="country" value="{{ customer.default_address.country }}" class="edit_account_input" placeholder="Country">
                    <div class="field-error"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="form_field_box">
               <div class="field_head">
                <h4>Shoe Size</h4>
                <p>This is the email address you used to sign up to Cap with.!</p>
              </div>
              <div class="fields">
                <div class="edit_account_field">
                  <input name="shoe_size" value="{{ customer.metafields.custom.shoe_size }}" class="edit_account_input" placeholder="Shoe Size">
                  <div class="field-error"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="form_submit_wrap">
            <button type="submit" id="saveProfileBtn" class="btn">Save Profile</button>
          </div>
          {% comment %} <h3>Profile</h3>
          <input name="first_name" value="{{ customer.first_name }}">
          <input name="last_name" value="{{ customer.last_name }}">
          <input name="email" value="{{ customer.email }}">
          <input name="phone" value="{{ customer.phone }}">
          <h3>Address</h3>
          {% assign addr = customer.default_address %}
          <input name="address1" value="{{ addr.address1 }}">
          <input name="address2" value="{{ addr.address2 }}">
          <input name="city" value="{{ addr.city }}">
          <input name="zip" value="{{ addr.zip }}">
          <input name="province" value="{{ addr.province }}">
          <input name="country" value="{{ addr.country }}">
          <h3>Extra</h3>
          <input name="age" value="{{ customer.metafields.custom.age }}">
          <input name="gender" value="{{ customer.metafields.custom.gender }}">
          <input name="shoe_size" value="{{ customer.metafields.custom.shoe_size }}">
          <input name="instagram" value="{{ customer.metafields.custom.instagram }}">
          <button type="submit">Save</button> {% endcomment %}
        </form>
      </div>
      {% comment %} <div>
        <h1 class="customer__title">{{ 'customer.account.title' | t }}</h1>
        <a href="{{ routes.account_logout_url }}">
          <span class="svg-wrapper">
            {{- 'icon-account.svg' | inline_asset_content -}}
          </span>
          {{ 'customer.log_out' | t }}
        </a>
      </div>
      <div>
        <div>
          <h2>{{ 'customer.orders.title' | t }}</h2>

          {% paginate customer.orders by 20 %}
            {%- if customer.orders.size > 0 -%}
              <table role="table" class="order-history">
                <caption class="visually-hidden">
                  {{ 'customer.orders.title' | t }}
                </caption>
                <thead role="rowgroup">
                  <tr role="row">
                    <th id="ColumnOrder" scope="col" role="columnheader">{{ 'customer.orders.order_number' | t }}</th>
                    <th id="ColumnDate" scope="col" role="columnheader">{{ 'customer.orders.date' | t }}</th>
                    <th id="ColumnPayment" scope="col" role="columnheader">{{ 'customer.orders.payment_status' | t }}</th>
                    <th id="ColumnFulfillment" scope="col" role="columnheader">
                      {{ 'customer.orders.fulfillment_status' | t }}
                    </th>
                    <th id="ColumnTotal" scope="col" role="columnheader">{{ 'customer.orders.total' | t }}</th>
                  </tr>
                </thead>
                <tbody role="rowgroup">
                  {%- for order in customer.orders -%}
                    <tr role="row">
                      <td
                        id="RowOrder"
                        role="cell"
                        headers="ColumnOrder"
                        data-label="{{ 'customer.orders.order_number' | t }}"
                      >
                        <a
                          href="{{ order.customer_url }}"
                          aria-label="{{ 'customer.orders.order_number_link' | t: number: order.name }}"
                        >
                          {{ order.name }}
                        </a>
                      </td>
                      <td headers="RowOrder ColumnDate" role="cell" data-label="{{ 'customer.orders.date' | t }}">
                        {{ order.created_at | time_tag: format: 'date' }}
                      </td>
                      <td
                        headers="RowOrder ColumnPayment"
                        role="cell"
                        data-label="{{ 'customer.orders.payment_status' | t }}"
                      >
                        {{ order.financial_status_label }}
                      </td>
                      <td
                        headers="RowOrder ColumnFulfillment"
                        role="cell"
                        data-label="{{ 'customer.orders.fulfillment_status' | t }}"
                      >
                        {{ order.fulfillment_status_label }}
                      </td>
                      <td headers="RowOrder ColumnTotal" role="cell" data-label="{{ 'customer.orders.total' | t }}">
                        {{ order.total_net_amount | money_with_currency }}
                      </td>
                    </tr>
                  {%- endfor -%}
                </tbody>
              </table>
            {%- else -%}
              <p>{{ 'customer.orders.none' | t }}</p>
            {%- endif -%}

            {%- if paginate.pages > 1 -%}
              {%- if paginate.parts.size > 0 -%}
                <nav class="pagination" role="navigation" aria-label="{{ 'general.pagination.label' | t }}">
                  <ul role="list">
                    {%- if paginate.previous -%}
                      <li>
                        <a href="{{ paginate.previous.url }}" aria-label="{{ 'general.pagination.previous' | t }}">
                          <span class="svg-wrapper">
                            {{- 'icon-caret.svg' | inline_asset_content -}}
                          </span>
                        </a>
                      </li>
                    {%- endif -%}

                    {%- for part in paginate.parts -%}
                      <li>
                        {%- if part.is_link -%}
                          <a href="{{ part.url }}" aria-label="{{ 'general.pagination.page' | t: number: part.title }}">
                            {{- part.title -}}
                          </a>
                        {%- else -%}
                          {%- if part.title == paginate.current_page -%}
                            <span aria-current="page" aria-label="{{ 'general.pagination.page' | t: number: part.title }}">
                              {{- part.title -}}
                            </span>
                          {%- else -%}
                            <span>{{ part.title }}</span>
                          {%- endif -%}
                        {%- endif -%}
                      </li>
                    {%- endfor -%}

                    {%- if paginate.next -%}
                      <li>
                        <a href="{{ paginate.next.url }}" aria-label="{{ 'general.pagination.next' | t }}">
                          <span class="svg-wrapper">
                            {{- 'icon-caret.svg' | inline_asset_content -}}
                          </span>
                        </a>
                      </li>
                    {%- endif -%}
                  </ul>
                </nav>
              {%- endif -%}
            {%- endif -%}
          {% endpaginate %}
        </div>

        <div>
          <h2>{{ 'customer.account.details' | t }}</h2>

          {{ customer.default_address | format_address }}

          <a href="{{ routes.account_addresses_url }}">
            {{ 'customer.account.view_addresses' | t }} ({{ customer.addresses_count }})
          </a>
        </div>
      </div> {% endcomment %}
    </div>
  </div>
</div>
<script>
const form = document.getElementById('profile-form');
const btn = document.getElementById("saveProfileBtn");

// --------------------
// IMAGE HANDLING
// --------------------
const input = document.getElementById('avatarInput');
const preview = document.getElementById('avatarPreview');
const removeBtn = document.getElementById('removeAvatar');

// Existing saved image (string URL from metafield)
let existingImageURL = "{{ customer.metafields.custom.profile_image | escape }}";

// Newly selected file
let selectedImageFile = null;

// Remove flag
let removeImage = false;

if (input) {
  input.addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;

    selectedImageFile = file;
    removeImage = false; // user selected new image

    // Preview
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.innerHTML = `<img src="${e.target.result}">`;
    };
    reader.readAsDataURL(file);
  });
}

if (removeBtn) {
  removeBtn.addEventListener('click', function() {
    preview.innerHTML = `<span class="avatar-letter">{{ customer.first_name | slice: 0, 1 }}</span>`;
    selectedImageFile = null;
    existingImageURL = "";
    removeImage = true; // ðŸ‘ˆ mark for deletion
  });
}

// --------------------
// VALIDATION
// --------------------
const requiredFields = [
  "first_name","last_name","email","phone",
  "address1","city","zip","province","country",
  "age","gender","shoe_size","instagram"
];

form.addEventListener("submit", function(e){
  e.preventDefault();

  let valid = true;

  // Reset errors
  document.querySelectorAll(".field-error").forEach(el => {
    el.innerText = "";
    el.style.display = "none";
  });
  document.querySelectorAll(".edit_account_input").forEach(el => {
    el.classList.remove("input-error");
  });

  // Required fields
  requiredFields.forEach(name => {
    const input = form.querySelector(`[name="${name}"]`);
    if (!input || input.value.trim() === "") {
      showError(input, "This field is required");
      valid = false;
    }
  });

  // Email
  const emailInput = form.querySelector('[name="email"]');
  if (emailInput && !/^\S+@\S+\.\S+$/.test(emailInput.value.trim())) {
    showError(emailInput, "Enter valid email address");
    valid = false;
  }

  // Phone +91XXXXXXXXXX
  const phoneInput = form.querySelector('[name="phone"]');
  if (phoneInput) {
    let phone = phoneInput.value.trim();

    if (/^[0-9]{10}$/.test(phone)) {
      phone = "+91" + phone;
      phoneInput.value = phone;
    }

    if (!/^\+91[0-9]{10}$/.test(phone)) {
      showError(phoneInput, "Phone must be in format +91XXXXXXXXXX");
      valid = false;
    }
  }

  // Age number
  const ageInput = form.querySelector('[name="age"]');
  if (ageInput && isNaN(ageInput.value)) {
    showError(ageInput, "Age must be a number");
    valid = false;
  }

  if (!valid) {
    scrollToFirstError();
    return;
  }

  submitProfile();
});

// --------------------
// ERROR UI
// --------------------
function showError(input, message) {
  if (!input) return;
  input.classList.add("input-error");
  let errorDiv = input.parentElement.querySelector(".field-error");
  if (!errorDiv) {
    errorDiv = document.createElement("div");
    errorDiv.className = "field-error";
    input.parentElement.appendChild(errorDiv);
  }
  errorDiv.innerText = message;
  errorDiv.style.display = "block";
}

function scrollToFirstError() {
  const first = document.querySelector(".input-error");
  if (first) first.scrollIntoView({behavior:"smooth", block:"center"});
}

// --------------------
// SUBMIT
// --------------------
async function submitProfile() {
  btn.disabled = true;
  btn.innerText = "Saving...";

  const formData = new FormData(form);

  // IMAGE LOGIC
  if (removeImage) {
    // Tell backend to remove image
    formData.append("remove_profile_picture", "1");
  } else if (selectedImageFile) {
    // Send new file
    formData.append("profile_picture", selectedImageFile);
  } else {
    // Keep existing
    formData.append("profile_picture", existingImageURL || "");
  }

  try {
    const res = await fetch("https://shopifycustom.kretosstechnology.com/api/v1/ludic-kitchen/customer/update", {
      method: "POST",
      body: formData
    });

    const result = await res.json();

    if (!res.ok) throw result;

    alert("Profile updated successfully!");
    location.reload();

  } catch (err) {
    console.error(err);
    alert("Something went wrong. Please try again.");
  } finally {
    btn.disabled = false;
    btn.innerText = "Save Profile";
  }
}
</script>



{% schema %}
{
  "name": "t:sections.main-account.name",
  "settings": [
    {
      "type": "header",
      "content": "Layout settings"
    },
    {
      "type": "text",
      "id": "max_width",
      "label": "Width container",
      "info": "Default: 1296px"
    },
    {
      "type": "checkbox",
      "id": "fullwidth",
      "label": "Fullwidth"
    },
    {
      "type": "text",
      "id": "padding",
      "label": "Padding",
      "placeholder": "0px 0px 0px 0px",
      "info":"Screen: desktop | 1200px | 991px | 767px"
    },
    {
      "type": "text",
      "id": "margin",
      "label": "Margin",
      "placeholder": "0px 0px 0px 0px",
      "info":"Screen: desktop | 1200px | 991px | 767px"
    }
  ]
}
{% endschema %}
