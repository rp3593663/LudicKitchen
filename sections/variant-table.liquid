{%- if section.settings.fullwidth -%}
	{%- assign container = 'container-full' -%}
{%- elsif section.settings.max_width != blank -%}
	{%- assign container = 'kretoss-container' -%}
{%- else -%}
	{%- assign container = 'page-width' -%}
{%- endif -%}

{%- assign max_width = '' -%}
{%- if section.settings.fullwidth == blank and section.settings.max_width != blank -%}
	{%- assign width_container = section.settings.max_width | plus: 0 -%}
	{%- capture max_width -%}style="max-width: {{ section.settings.max_width }};"{%- endcapture -%}
{%- endif -%}

{% assign margin 	= section.settings.margin | split: "|" %}
{% assign padding 	= section.settings.padding | split: "|" %}
{%- style -%}
  {%- if margin[0] != blank or padding[0] != blank -%}
		#shopify-section-{{ section.id }} .section-project_variant_table{
			{%- if margin[0] != blank -%}margin: {{ margin[0] }};{%- endif -%}
			{%- if padding[0] != blank -%}padding:{{ padding[0] }};{%- endif -%}
		}
	{%- endif -%}
	{%- if margin[1] != blank or padding[1] != blank -%}
		@media (max-width:1200px){
			#shopify-section-{{ section.id }} .section-project_variant_table{
				{%- if margin[1] != blank -%}margin: {{ margin[1] }};{%- endif -%}
				{%- if padding[1] != blank -%}padding:{{ padding[1] }};{%- endif -%}
			}
		}
	{%- endif -%}
	{%- if margin[2] != blank or padding[2] != blank -%}
		@media (max-width:991px){
			#shopify-section-{{ section.id }} .section-project_variant_table{
				{%- if margin[2] != blank -%}margin: {{ margin[2] }};{%- endif -%}
				{%- if padding[2] != blank -%}padding:{{ padding[2] }};{%- endif -%}
			}
		}
	{%- endif -%}
	{%- if margin[3] != blank or padding[3] != blank -%}
		@media (max-width:767px){
			#shopify-section-{{ section.id }} .section-project_variant_table{
				{%- if margin[3] != blank -%}margin: {{ margin[3] }};{%- endif -%}
				{%- if padding[3] != blank -%}padding:{{ padding[3] }};{%- endif -%}
			}
		}
	{%- endif -%}

{%- endstyle -%}

<div class="kretoss-section section-project_variant_table video-trigger-section" id="choose_product_tier"
  {% if section.settings.section_video != blank %}
    data-video-src="{{ section.settings.section_video.sources[0].url }}"
    data-thumb="{{ section.settings.section_video_poster | image_url }}"
    data-title="{{ section.settings.section_video_title | escape }}"
    data-text="{{ section.settings.section_video_text }}"
    data-popup-title="{{ section.settings.section_popup_title | escape }}"
    data-popup-text="{{ section.settings.section_popup_text | replace: '"', '&quot;' }}"
  {% endif %}
>

	<div class="{{ container }}" {{ max_width }}>
        <div class="section_heading">
            <h2 class="h2_title">
                Where you sit <span class="border_text"><img src="https://cdn.shopify.com/s/files/1/0962/3794/5196/files/title_round.svg?v=1766058214">matters</span>
            </h2>
            <p>How close you sit shapes how involved you are. Each tier offers a different way to participate, from observing early to shaping decisions along the way.</p>
            <p>Pick what feels right for you.</p>
        </div>


      {% comment %} Pier Tier table content {% endcomment %}

      <div class="section-project_tier_benefits">
        <div class="tier_benefits_inner">
            <div class="tier_benefits_table">
                <div class="tier_benefits_head">
                    <div> </div>
                    {% for variant in product.variants %}
                    <div>
                        <h2>
                          <a href="#tier-{{ variant.title | handleize }}">
                              {{ variant.title }}
                          </a>
                        </h2>
                        <img src="{{ variant.metafields.custom.tier_image | image_url }}">
                    </div>
                    {% endfor %}
                </div>

                <div class="tier_benefits_body">
                    {% for block in section.blocks %}
                        <div class="tier_benefits">
                            <div class="tier_features">
                                <div class="features_info">
                                    <h4>{{ block.settings.title }}</h4>
                                    <div class="description">
                                      {{ block.settings.short_text }}
                                      {% if block.settings.more_text != blank %}
                                          <span class="more_info"> Learn More</span>
                                          <div class="more_info_block">
                                          {{ block.settings.more_text }}
                                          </div>
                                      {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% for variant in product.variants %}
                                {% case forloop.index %}
                                  {% when 1 %}
                                    {% assign enabled = block.settings.tier_1 %}
                                    {% assign custom_text = block.settings.tier_1_text %}
                                  {% when 2 %}
                                    {% assign enabled = block.settings.tier_2 %}
                                    {% assign custom_text = block.settings.tier_2_text %}
                                  {% when 3 %}
                                    {% assign enabled = block.settings.tier_3 %}
                                    {% assign custom_text = block.settings.tier_3_text %}
                                  {% when 4 %}
                                    {% assign enabled = block.settings.tier_4 %}
                                    {% assign custom_text = block.settings.tier_4_text %}
                                  {% when 5 %}
                                    {% assign enabled = block.settings.tier_5 %}
                                    {% assign custom_text = block.settings.tier_5_text %}
                                  {% when 6 %}
                                    {% assign enabled = block.settings.tier_6 %}
                                    {% assign custom_text = block.settings.tier_6_text %}
                                  {% else %}
                                    {% assign enabled = false %}
                                    {% assign custom_text = '' %}
                                {% endcase %}


                                <div class="tier_benefit_yes_no">
                                  {% if custom_text != blank %}
                                    <span class="tier_custom_text">{{ custom_text }}</span>
                                  {% else %}
                                      <img src="{% if enabled %}{{ section.settings.icon_yes | image_url }}{% else %}{{ section.settings.icon_no | image_url }}{% endif %}" alt="{{ variant.title }}">
                                  {% endif %}
                                    
                                </div>
                            {% endfor %}
                            {% comment %} <div class="tier_mobile_description">{{ block.settings.more_text }}</div> {% endcomment %}
                            <div class="tier_mobile_description">{{ block.settings.short_text }}</div>
                        </div>  
                    {% endfor %}
                </div>
            </div>
        </div>
      </div>



        <div class="tier_table_inner">
            {% for variant in product.variants %}
              {% assign current_reached_goal = variant.metafields.custom.current_reached_tier_goal | default: 0 %}
                <div class="tier_box" id="tier-{{ variant.title | handleize }}">

                <!-- Variant Image (fallback to product image) -->
                <div class="tier_image">
                    <img
                    src="{{ variant.metafields.custom.tier_image | image_url }}"
                    alt="{{ variant.title }}"
                    loading="lazy">
                </div>

                <div class="tier_data">
                    
                    
                    <!-- Variant Title -->
                    <div class="tier_title">
                        <h3>{{ variant.title }}</h3>
                        <div class="reached_tier">
                          <div class="tier_badge">
                            <img src="{{ 'tier_' | append: forloop.index | append: '.svg' | asset_url }}">
                            Tier {{ forloop.index }}
                          </div>
                          {% comment %} <div class="current_tier_reached">{{ current_reached_goal }} {{ variant.title }}</div> {% endcomment %}
                          <div class="current_tier_reached">
                            <div class="status-indicator">
                              <span class="pulse"></span>
                              <span class="dot"></span>
                            </div>
                            Early Bird
                          </div>
                        </div>
                    </div>

                    <div class="tier_access">
                      <p>{{ variant.metafields.custom.tier_caption.value }}</p>
                    </div>

                    <!-- Short Description -->
                    {% if variant.metafields.custom.variant_short_info != blank %}
                    <div class="tier_information">
                        {{ variant.metafields.custom.variant_short_info | metafield_text }}
                    </div>
                    {% endif %}

                    <!-- Info Points -->
                    {% if variant.metafields.custom.variant_info_points.value != blank %}
                    <div class="tier_info_points">
                        {% for point in variant.metafields.custom.variant_info_points.value %}
                        <div class="tier_feature">
                            <img src="https://cdn.shopify.com/s/files/1/0962/3794/5196/files/askrisk_blue.svg?v=1766058821">
                            <span>{{ point }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Estimated Delivery Date -->
                    {% if variant.metafields.custom.estimated_delivery_date != blank %}
                    <div class="tier_estimated">
                        {% comment %} Estimated delivery date
                        {{ variant.metafields.custom.estimated_delivery_date | date: "%d %B %Y" }} {% endcomment %}
                    </div>
                    {% endif %}

                    <!-- Prices -->
                    <div class="tier_price_block">
                      <div class="tier_price">
                          <div class="sale_price">
                          {{ variant.price | money }}
                          </div>

                          {% if variant.compare_at_price > variant.price %}
                          <div class="regular_price">
                              {{ variant.compare_at_price | money }}
                          </div>
                          {% endif %}
                      </div>
                      <span>(Inclusive of all taxes)</span>
                    </div>


                       
                     <div class="tier_early_bird_timer">
                      <div class="tier_timer_inner">
                        <p>Early bird ends in</p>
                        <p class="earlyBirdTimer"></p>
                      </div>
                    </div>


                    <!-- Progress + Button -->
                    <div class="tier_progress_btn">
                      {% assign goal_start_date = product.metafields.custom.project_goal_start_date %}
                      {% assign total_days = 15 %}

                      {% if goal_start_date != blank %}

                        {%- assign goal_start_ts = goal_start_date | date: "%s" -%}
                        {%- assign today_ts = 'now' | date: "%s" -%}

                        {%- assign seconds_passed = today_ts | minus: goal_start_ts -%}
                        {%- assign days_passed = seconds_passed | divided_by: 86400 -%}

                        {%- assign tier_progress = days_passed | times: 100.0 | divided_by: total_days | round: 2 -%}

                      {% else %}
                        {% assign tier_progress = 0 %}
                      {% endif %}

                      {%- comment -%} Clamp progress between 0 and 100 {%- endcomment -%}
                      {% if tier_progress > 100 %}
                        {% assign tier_progress = 100 %}
                      {% endif %}

                      {% if tier_progress < 0 %}
                        {% assign tier_progress = 0 %}
                      {% endif %}

                      {%- comment -%} Minimum visible bar width {%- endcomment -%}
                      {% assign tier_bar_width = tier_progress %}
                      {% if tier_bar_width < 2 %}
                        {% assign tier_bar_width = 2 %}
                      {% endif %}

                      {% comment %} <div class="tier_progress_bar">
                        <div class="tier_track segmented">
                          <div
                            class="tier_track_progress_fill"
                            style="width: {{ tier_bar_width }}%;"
                          > </div>
                        </div>
                      </div> {% endcomment %}


                      <!-- Direct Checkout Link -->
                      <button type="button" class="theme_btn tier_btn js-tier-checkout" data-variant-id="{{ variant.id }}">
                        <span class="btn-text">Become a {{ variant.title }}</span>
                        <span class="btn-loader" style="display:none;">Joining...</span>
                      </button>   

                      {% comment %} <a
                          href="/checkout?variant={{ variant.id }}&quantity=1"
                          class="theme_btn tier_btn">
                          Choose {{ variant.title }}
                      </a> {% endcomment %}
                    </div>

                </div>
                </div>
            {% endfor %}
        </div>
	</div>
</div>
<script>
  {% if customer %}
    window.__customerLoggedIn = true;
    window.__customerHasOrders = {{ customer.orders_count | json }};
  {% else %}
    window.__customerLoggedIn = false;
    window.__customerHasOrders = 0;
  {% endif %}

  window.__currentPageUrl = {{ request.path | json }};
</script>



<script>
document.addEventListener("DOMContentLoaded", function () {

  document.querySelectorAll(".js-tier-checkout").forEach(button => {

    const btnText = button.querySelector(".btn-text");
    const btnLoader = button.querySelector(".btn-loader");

    // ðŸš« If user is logged in AND already has an order â†’ disable button
    if (window.__customerLoggedIn && window.__customerHasOrders > 0) {
      button.disabled = true;
      button.classList.add("is-disabled");
      btnText.textContent = "Already Joined";
      return; // stop here, do not attach click event
    }

    // Otherwise normal behavior
    button.addEventListener("click", function () {

      const variantId = this.dataset.variantId;

      // ðŸ”’ If not logged in â†’ redirect to login first
      if (!window.__customerLoggedIn) {
        const baseUrl = window.location.origin + window.location.pathname;
        const returnUrl = encodeURIComponent(baseUrl + "#choose_product_tier");
        window.location.href = `/account/login?return_url=${returnUrl}`;
        return;
      }
      

      // UI loading state
      this.disabled = true;
      btnText.style.display = "none";
      btnLoader.style.display = "inline-block";

            // ðŸ§¹ First clear the cart completely
      fetch("/cart/clear.js", {
        method: "POST",
        headers: {
          "Accept": "application/json"
        }
      })
      .then(() => {
        // âž• Then add only this variant
        return fetch("/cart/add.js", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({
            id: variantId,
            quantity: 1
          })
        });
      })
      .then(response => {
        if (!response.ok) throw new Error("Add to cart failed");
        return response.json();
      })
      .then(() => {
        // ðŸš€ Go to checkout with ONLY this product
        window.location.href = "/checkout";
      })
      .catch(error => {
        console.error(error);
        alert("Something went wrong. Please try again.");

        // Restore button state
        this.disabled = false;
        btnLoader.style.display = "none";
        btnText.style.display = "inline-block";
      });

    });

  });

});

</script>

<script>
  window.addEventListener("pageshow", function (event) {
    // Safari back/forward cache restore
    if (event.persisted) {
      document.querySelectorAll(".js-tier-checkout").forEach(button => {
        const btnText = button.querySelector(".btn-text");
        const btnLoader = button.querySelector(".btn-loader");

        // Reset UI state
        button.disabled = false;
        btnLoader.style.display = "none";
        btnText.style.display = "inline-block";
      });
    }
  });
</script>

<script>
  function initEarlyBirdTimers() {
    const endDate = new Date(2026, 1, 22, 12, 0, 0); // Feb 22, 12 PM

    document.querySelectorAll(".earlyBirdTimer").forEach(timerEl => {

      function updateTimer() {
        const now = new Date();
        const diff = endDate - now;

        if (diff <= 0) {
          timerEl.innerHTML = "Expired";
          return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));

        timerEl.innerHTML =
        `<span class="timer-unit">
          <span class="timer-num">${days} Days</span>
          <span class="timer-label">Days</span>
        </span>`;
      }

      updateTimer();

      // ðŸ”¥ Since only days are shown, update once every hour is enough
      setInterval(updateTimer, 60 * 60 * 1000);
    });
  }

  document.addEventListener("DOMContentLoaded", initEarlyBirdTimers);

  // Re-run when variant changes
  document.addEventListener("variant:change", initEarlyBirdTimers);
</script>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tierItems = document.querySelectorAll('.tier_benefits');

    if (!tierItems.length) return;

    // Close all except first on load
    tierItems.forEach((item, index) => {
      const desc = item.querySelector('.tier_mobile_description');
      if (!desc) return;

      if (index === 0) {
        desc.style.display = 'block';
        item.classList.add('active');
      } else {
        desc.style.display = 'none';
      }
    });

    // Click handler
    tierItems.forEach(item => {
      const title = item.querySelector('.features_info h4');
      const desc = item.querySelector('.tier_mobile_description');

      if (!title || !desc) return;

      title.addEventListener('click', () => {
        const isOpen = item.classList.contains('active');

        // Close all
        tierItems.forEach(i => {
          i.classList.remove('active');
          const d = i.querySelector('.tier_mobile_description');
          if (d) d.style.display = 'none';
        });

        // Toggle current
        if (!isOpen) {
          desc.style.display = 'block';
          item.classList.add('active');
        }
      });
    });
  });
</script>


<script>
  document.querySelectorAll('.tier_benefits_head a').forEach(link => {
  link.addEventListener('click', function(e) {
    e.preventDefault();
    const target = document.querySelector(this.getAttribute('href'));
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
});

</script>

{% schema %}
{
  "name": "Project Variant Table",
  "settings": [
    {
      "type": "header",
      "content": "Layout settings"
    },
    {
      "type": "text",
      "id": "max_width",
      "label": "Width container",
      "info": "Default: 1296px"
    },
    {
      "type": "checkbox",
      "id": "fullwidth",
      "label": "Fullwidth"
    },
    {
      "type": "text",
      "id": "padding",
      "label": "Padding",
      "placeholder": "0px 0px 0px 0px",
      "info":"Screen: desktop | 1200px | 991px | 767px"
    },
    {
      "type": "text",
      "id": "margin",
      "label": "Margin",
      "placeholder": "0px 0px 0px 0px",
      "info":"Screen: desktop | 1200px | 991px | 767px"
    },
    {
      "type": "video",
      "id": "section_video",
      "label": "Section Video"
    },
    {
      "type": "image_picker",
      "id": "section_video_poster",
      "label": "Video Poster / Thumbnail"
    },
    {
      "type": "text",
      "id": "section_video_title",
      "label": "Sticky Video Title",
      "default": "How this works"
    },
    {
      "type": "text",
      "id": "section_video_text",
      "label": "Sticky Video Text",
      "default": "Get a better understanding of how ludic kitchen works."
    },
    {
      "type": "text",
      "id": "section_popup_title",
      "label": "Popup Title",
      "default": "How Kitchen works"
    },
    {
      "type": "textarea",
      "id": "section_popup_text",
      "label": "Popup Text",
      "default": "Many hands, one shared intention. Every project here follows a simple path..."
    },
    {
      "type": "image_picker",
      "id": "icon_yes",
      "label": "Yes icon"
    },
    {
      "type": "image_picker",
      "id": "icon_no",
      "label": "No icon"
    }
  ],
   "blocks": [
    {
      "type": "benefit",
      "name": "Benefit row",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Benefit title"
        },
        {
          "type": "text",
          "id": "short_text",
          "label": "Short description"
        },
        {
          "type": "textarea",
          "id": "more_text",
          "label": "Learn more text"
        },
        {
          "type": "header",
          "content": "Select Yes or No",
          "info": "Please select yes no according your variant numbers no need to all."
        },
        {
          "type": "checkbox",
          "id": "tier_1",
          "label": "Tier 1 (Yes or No)"
        },
        {
          "type": "text",
          "id": "tier_1_text",
          "label": "Tier 1 Custom text"
        },
        {
          "type": "checkbox",
          "id": "tier_2",
          "label": "Tier 2 (Yes or No)"
        },
        {
          "type": "text",
          "id": "tier_2_text",
          "label": "Tier 2 Custom text"
        },
        {
          "type": "checkbox",
          "id": "tier_3",
          "label": "Tier 3 (Yes or No)"
        },
        {
          "type": "text",
          "id": "tier_3_text",
          "label": "Tier 3 Custom text"
        },
        {
          "type": "checkbox",
          "id": "tier_4",
          "label": "Tier 4 (Yes or No)"
        },
        {
          "type": "text",
          "id": "tier_4_text",
          "label": "Tier 4 Custom text"
        },
        {
          "type": "checkbox",
          "id": "tier_5",
          "label": "Tier 5 (Yes or No)"
        },
        {
          "type": "text",
          "id": "tier_5_text",
          "label": "Tier 5 Custom text"
        },
        {
          "type": "checkbox",
          "id": "tier_6",
          "label": "Tier 6 (Yes or No)"
        },
        {
          "type": "text",
          "id": "tier_6_text",
          "label": "Tier 6 Custom text"
        },
      ]
    }
  ],
	"presets": [
		{
			"name": "Project Variant Table"
		}
    ]
}
{% endschema %}